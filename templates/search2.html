{% include "includes/header.html" with title="Recherche" %}
{% load widget_tweaks %}

<div class="h-full w-full flex items-start">

    {% include "includes/menu.html" with title="Recherche" %}

    <div class="w-full h-full relative p-3" style="background: #fafbfd;">

        <div class="loading-div z-10 absolute left-0 top-0 bottom-0 right-0" style="background: #fafbfd;">
            <div class="absolute inset-center text-sm flex">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Chargement des données
            </div>
        </div>

        <div class="flex flex-col bg-white rounded h-full relative w-full" style="border: 1px solid rgb(211, 218, 230); padding: 6px 8px">

            <div class="my-3 mt-1 flex w-full bg-yellow-100 border border-yellow-300 rounded text-xs p-4 items-center text-yellow-800">
                <!--- Orange box -->
                <svg class="w-4 h-4 text-yellow-800 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>

                {% for message in messages %}

                    <p>
                        {{ message }}
                    </p>
                {% empty %}
                    <p>Cet outil permet d'interroger la base de données collectées et enrichies et est à destination d'un public expert. </p>
                {% endfor %}

            </div>

          <div style="box-sizing: border-box; display:inline-flex;width: 50%;">
            <form action="/search/?{% if struct %}struct={{ struct }}{% endif %}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if ldapid %}&ldapid={{ ldapid }}{% endif %}" method="post">
                {% csrf_token %}
                {% for field in form.visible_fields %}
                   <!--  <label class="text-sm text-gray-700" for="{{ field.auto_id }}">{{ field.label }}</label>-->
                   {% render_field field class="flex text-sm py-1 px-2 border rounded border-gray-200 focus-none outline-none" value="*" %}
                {% endfor %}
            <input class="text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer validate outline-none" type="submit" value="Rechercher">
            </form>
            </div>


               <!-- <h3 class="text-xs font-semibold my-2">Mots-clés associés</h3> 4ec4e950-8716-11eb-b61e-8702cc892037--->
       <!-- <iframe src="{{ url }}/app/dashboards#/view/2a24f410-f6ae-11ec-a664-216eaa7662bc?embed=true&_g=(filters:!())&_a=(description:'Ce%20Dashboard%20couvre%20la%20recherche%20d!'expert%20Sovisu',filters:!(),fullScreenMode:!f,options:(hidePanelTitles:!t,syncColors:!t,syncTooltips:!t,useMargins:!f),panels:!((embeddableConfig:(enhancements:(),hidePanelTitles:!t,savedVis:(data:(aggs:!((enabled:!t,id:'1',params:(emptyAsNull:!f),schema:metric,type:count),(enabled:!t,id:'2',params:(customLabel:'Mots-cl%C3%A9s%20auteurs',field:fr_keyword_s.keyword,missingBucket:!f,missingBucketLabel:Missing,order:desc,orderBy:'1',otherBucket:!t,otherBucketLabel:Autres,size:50),schema:segment,type:terms)),searchSource:(filter:!(),index:'6dc92aa0-d03f-11ec-8d09-e9256d2694b8',query:(language:kuery,query:''))),description:'',id:'',params:(maxFontSize:50,minFontSize:10,orientation:single,palette:(name:default,type:palette),scale:linear,showLabel:!t),title:'',type:tagcloud,uiState:())),gridData:(h:18,i:a2fa874b-6544-48a8-a374-c1e6f9faff02,w:26,x:0,y:0),panelIndex:a2fa874b-6544-48a8-a374-c1e6f9faff02,type:visualization,version:'8.3.2'),(embeddableConfig:(enhancements:(),hidePanelTitles:!t),gridData:(h:18,i:'36de0b7d-b9e5-4f2f-9db4-b4b733bb438e',w:22,x:26,y:0),id:'0453c5f0-f49b-11ec-a0f0-8fb596d90e57',panelIndex:'36de0b7d-b9e5-4f2f-9db4-b4b733bb438e',type:visualization,version:'8.3.2'),(embeddableConfig:(enhancements:(),hidePanelTitles:!f,savedVis:(data:(aggs:!((enabled:!t,id:'1',params:(emptyAsNull:!f),schema:metric,type:count),(enabled:!t,id:'2',params:(customLabel:'Entit%C3%A9s%20nomm%C3%A9es%20(FR)',field:en_entites.keyword,missingBucket:!f,missingBucketLabel:Missing,order:desc,orderBy:'1',otherBucket:!t,otherBucketLabel:Autres,size:50),schema:segment,type:terms)),searchSource:(filter:!(),index:'3bc3de40-f378-11ec-a0f0-8fb596d90e57',query:(language:kuery,query:''))),description:'',params:(maxFontSize:72,minFontSize:18,orientation:single,palette:(name:default,type:palette),scale:linear,showLabel:!t),title:'fr_teeft%20(copy%201)',type:tagcloud,uiState:())),gridData:(h:19,i:'0fcd36af-a558-45e1-a913-699672a93d59',w:26,x:0,y:18),panelIndex:'0fcd36af-a558-45e1-a913-699672a93d59',title:'Entit%C3%A9s%20Nomm%C3%A9es%20(fr)',type:visualization,version:'8.3.2'),(embeddableConfig:(attributes:(references:!((id:'3bc3de40-f378-11ec-a0f0-8fb596d90e57',name:indexpattern-datasource-layer-34d48a89-fa68-489f-9c0a-d291326e5e42,type:index-pattern)),state:(datasourceStates:(indexpattern:(layers:('34d48a89-fa68-489f-9c0a-d291326e5e42':(columnOrder:!(ad5b0f9d-13e6-4e1c-b62e-dd7c6b688ec2,'7f181d5b-8152-47db-a7c8-a84b25545685','1d796e62-f50e-40bb-a45d-136af34baaa2','62ba9e3c-fe76-4908-8174-9eca7dbe40b9'),columns:('1d796e62-f50e-40bb-a45d-136af34baaa2':(customLabel:!t,dataType:string,isBucketed:!t,label:Labo,operationType:terms,params:(accuracyMode:!t,missingBucket:!f,orderBy:(columnId:'62ba9e3c-fe76-4908-8174-9eca7dbe40b9',type:column),orderDirection:desc,otherBucket:!t,parentFormat:(id:terms),size:3),scale:ordinal,sourceField:harvested_from_label.keyword),'62ba9e3c-fe76-4908-8174-9eca7dbe40b9':(customLabel:!t,dataType:number,isBucketed:!f,label:Documents,operationType:unique_count,scale:ratio,sourceField:doiId_s.keyword),'7f181d5b-8152-47db-a7c8-a84b25545685':(customLabel:!t,dataType:string,isBucketed:!t,label:Experts,operationType:terms,params:(accuracyMode:!t,missingBucket:!f,orderBy:(columnId:'62ba9e3c-fe76-4908-8174-9eca7dbe40b9',type:column),orderDirection:desc,otherBucket:!t,parentFormat:(id:terms),size:1),scale:ordinal,sourceField:authFullName_s.keyword),ad5b0f9d-13e6-4e1c-b62e-dd7c6b688ec2:(customLabel:!t,dataType:string,isBucketed:!t,label:IdHal,operationType:terms,params:(accuracyMode:!t,missingBucket:!f,orderBy:(columnId:'62ba9e3c-fe76-4908-8174-9eca7dbe40b9',type:column),orderDirection:desc,otherBucket:!t,size:16),scale:ordinal,sourceField:harvested_from_ids.keyword)),incompleteColumns:())))),filters:!(),query:(language:kuery,query:''),visualization:(columns:!((columnId:ad5b0f9d-13e6-4e1c-b62e-dd7c6b688ec2,hidden:!t,isTransposed:!f),(columnId:'62ba9e3c-fe76-4908-8174-9eca7dbe40b9',isTransposed:!f),(alignment:center,columnId:'1d796e62-f50e-40bb-a45d-136af34baaa2',isTransposed:!f),(columnId:'7f181d5b-8152-47db-a7c8-a84b25545685',isTransposed:!f)),layerId:'34d48a89-fa68-489f-9c0a-d291326e5e42',layerType:data,rowHeight:single,rowHeightLines:1)),title:'',type:lens,visualizationType:lnsDatatable),enhancements:(),hidePanelTitles:!t),gridData:(h:19,i:'46142084-9365-4f98-81db-7e357938bdac',w:22,x:26,y:18),panelIndex:'46142084-9365-4f98-81db-7e357938bdac',type:lens,version:'8.3.2')),query:(language:kuery,query:''),tags:!(a0a62870-aca4-11eb-b298-750a560150e0),timeRange:(from:now-15y,to:now),timeRestore:!t,title:'Search%20Dashboard%20%20(FR)',viewMode:edit)&show-top-menu=true&show-query-input=true&show-time-filter=true" height="100%" width="100%"></iframe>
        -->


        {% if results %}
            <iframe src="http://localhost:5601/app/dashboards#/view/bd66cf00-30ec-11ed-b396-4149dffa7723?embed=true&_g=(filters%3A!('{{ search }}')%2CrefreshInterval%3A(pause%3A!t%2Cvalue%3A0)%2Ctime%3A(from%3Anow-31y%2Cto%3Anow),viewMode:edit)&&show-query-input=true&show-time-filter=true" height="100%" width="100%"></iframe>
{#           <iframe src="http://localhost:5601/app/dashboards#/view/bd66cf00-30ec-11ed-b396-4149dffa7723?embed=true&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-31y,to:now))&_a=(description:'Ce%20Dashboard%20couvre%20la%20recherche%20d!'expert%20Sovisu',filters:!(),fullScreenMode:!f,options:(hidePanelTitles:!t,syncColors:!t,syncTooltips:!t,useMargins:!f),panels:!((embeddableConfig:(enhancements:(),hidePanelTitles:!t,savedVis:(data:(aggs:!((enabled:!t,id:'1',params:(emptyAsNull:!f),schema:metric,type:count),(enabled:!t,id:'2',params:(customLabel:'Mots-cl%C3%A9s%20auteurs',field:fr_keyword_s.keyword,missingBucket:!f,missingBucketLabel:Missing,order:desc,orderBy:'1',otherBucket:!t,otherBucketLabel:Autres,size:50),schema:segment,type:terms)),searchSource:(filter:!(),index:'6dc92aa0-d03f-11ec-8d09-e9256d2694b8',query:(language:kuery,query:''))),description:'',id:'',params:(maxFontSize:50,minFontSize:10,orientation:single,palette:(name:default,type:palette),scale:linear,showLabel:!t),title:'',type:tagcloud,uiState:())),gridData:(h:18,i:a2fa874b-6544-48a8-a374-c1e6f9faff02,w:26,x:0,y:0),panelIndex:a2fa874b-6544-48a8-a374-c1e6f9faff02,type:visualization,version:'8.3.2'),(embeddableConfig:(enhancements:(),hidePanelTitles:!t),gridData:(h:18,i:'36de0b7d-b9e5-4f2f-9db4-b4b733bb438e',w:22,x:26,y:0),id:'0453c5f0-f49b-11ec-a0f0-8fb596d90e57',panelIndex:'36de0b7d-b9e5-4f2f-9db4-b4b733bb438e',type:visualization,version:'8.3.2'),(embeddableConfig:(enhancements:(),hidePanelTitles:!f,savedVis:(data:(aggs:!((enabled:!t,id:'1',params:(emptyAsNull:!f),schema:metric,type:count),(enabled:!t,id:'2',params:(customLabel:'Entit%C3%A9s%20nomm%C3%A9es%20(FR)',field:fr_entites.keyword,missingBucket:!f,missingBucketLabel:Missing,order:desc,orderBy:'1',otherBucket:!t,otherBucketLabel:Autres,size:50),schema:segment,type:terms)),searchSource:(filter:!(),index:'6dc92aa0-d03f-11ec-8d09-e9256d2694b8',query:(language:kuery,query:''))),description:'',params:(maxFontSize:72,minFontSize:18,orientation:single,palette:(name:default,type:palette),scale:linear,showLabel:!t),title:'fr_teeft%20(copy%201)',type:tagcloud,uiState:())),gridData:(h:19,i:'0fcd36af-a558-45e1-a913-699672a93d59',w:26,x:0,y:18),panelIndex:'0fcd36af-a558-45e1-a913-699672a93d59',title:'Entit%C3%A9s%20Nomm%C3%A9es%20(fr)',type:visualization,version:'8.3.2'),(embeddableConfig:(attributes:(references:!((id:b97e5f90-304f-11ed-b396-4149dffa7723,name:indexpattern-datasource-layer-34d48a89-fa68-489f-9c0a-d291326e5e42,type:index-pattern)),state:(datasourceStates:(indexpattern:(layers:('34d48a89-fa68-489f-9c0a-d291326e5e42':(columnOrder:!(ad5b0f9d-13e6-4e1c-b62e-dd7c6b688ec2,'7f181d5b-8152-47db-a7c8-a84b25545685','1d796e62-f50e-40bb-a45d-136af34baaa2','62ba9e3c-fe76-4908-8174-9eca7dbe40b9'),columns:('1d796e62-f50e-40bb-a45d-136af34baaa2':(customLabel:!t,dataType:string,isBucketed:!t,label:Labo,operationType:terms,params:(accuracyMode:!t,missingBucket:!f,orderBy:(columnId:'62ba9e3c-fe76-4908-8174-9eca7dbe40b9',type:column),orderDirection:desc,otherBucket:!t,parentFormat:(id:terms),size:3),scale:ordinal,sourceField:harvested_from_label.keyword),'62ba9e3c-fe76-4908-8174-9eca7dbe40b9':(customLabel:!t,dataType:number,isBucketed:!f,label:Documents,operationType:unique_count,scale:ratio,sourceField:doiId_s.keyword),'7f181d5b-8152-47db-a7c8-a84b25545685':(customLabel:!t,dataType:string,isBucketed:!t,label:Experts,operationType:terms,params:(accuracyMode:!t,missingBucket:!f,orderBy:(columnId:'62ba9e3c-fe76-4908-8174-9eca7dbe40b9',type:column),orderDirection:desc,otherBucket:!t,parentFormat:(id:terms),size:1),scale:ordinal,sourceField:authFullName_s.keyword),ad5b0f9d-13e6-4e1c-b62e-dd7c6b688ec2:(customLabel:!t,dataType:string,isBucketed:!t,label:IdHal,operationType:terms,params:(accuracyMode:!t,missingBucket:!f,orderBy:(columnId:'62ba9e3c-fe76-4908-8174-9eca7dbe40b9',type:column),orderDirection:desc,otherBucket:!t,size:16),scale:ordinal,sourceField:harvested_from_ids.keyword)),incompleteColumns:())))),filters:!(),query:(language:kuery,query:''),visualization:(columns:!((columnId:ad5b0f9d-13e6-4e1c-b62e-dd7c6b688ec2,hidden:!t,isTransposed:!f),(columnId:'62ba9e3c-fe76-4908-8174-9eca7dbe40b9',isTransposed:!f),(alignment:center,columnId:'1d796e62-f50e-40bb-a45d-136af34baaa2',isTransposed:!f),(columnId:'7f181d5b-8152-47db-a7c8-a84b25545685',isTransposed:!f)),layerId:'34d48a89-fa68-489f-9c0a-d291326e5e42',layerType:data,rowHeight:single,rowHeightLines:1)),title:'',type:lens,visualizationType:lnsDatatable),enhancements:(),hidePanelTitles:!t),gridData:(h:19,i:'46142084-9365-4f98-81db-7e357938bdac',w:22,x:26,y:18),panelIndex:'46142084-9365-4f98-81db-7e357938bdac',type:lens,version:'8.3.2')),query:(language:kuery,query:'{{search}}'),tags:!(a0a62870-aca4-11eb-b298-750a560150e0),timeRange:(from:now-31y,to:now),timeRestore:!t,title:'Search%20Dashboard%20%20(FR)',viewMode:edit)&show-query-input=true&show-time-filter=true" ></iframe>#}
        {% else %}
            <iframe src="http://localhost:5601/app/dashboards#/view/bd66cf00-30ec-11ed-b396-4149dffa7723?embed=true&_g=(filters%3A!()%2CrefreshInterval%3A(pause%3A!t%2Cvalue%3A0)%2Ctime%3A(from%3Anow-31y%2Cto%3Anow),viewMode:edit)&&show-query-input=true&show-time-filter=true" height="100%" width="100%"></iframe>
       {% endif %}#}

        </div>

    </div>

</div>

<script>

    {% if results.0.docid %}
        cols = [
                {
                    "targets": [ 0 ],
                    "render": function(data, type, row, meta){
                        if(type === 'display'){
                            data = '<a class="underline text-blue-700" target="_blank" href="https://hal.archives-ouvertes.fr/' + data + '">' + data + '</a>';
                        }
                        return data;
                    },
                    "className": "text-center",
                    "orderable": false
                }
            ]
    {%  endif %}
    {% if results.0.ldapId %}
        cols = [
            {
                    "targets": [ 0 ],
                    "render": function(data, type, row, meta){
                        if(type === 'display'){
                            data = '<a class="underline text-blue-700" target="_blank" href="https://hal.archives-ouvertes.fr/search/index/?q=%2A&authIdHal_s=' + data + '">' + data + '</a>';
                        }
                        return data;
                    },
                    "className": "text-center",
                    "orderable": false
                }
            ]
    {%  endif %}
    {% if results.0.rsnr %}
        cols = [
            {
                    "targets": [ 0 ],
                    "render": function(data, type, row, meta){
                        if(type === 'display'){
                            data = '<a class="underline text-blue-700" target="_blank" href="https://hal.archives-ouvertes.fr/search/index/?q=%2A&labStructId_i=' + data + '">' + data + '</a>';
                        }
                        return data;
                    },
                    "className": "text-center",
                    "orderable": false
                }
            ]    {%  endif %}

    var table = $('#references').DataTable(
        {
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.10.22/i18n/French.json'
            },
            dom: 'Bfrtip',
            select: false,
            columnDefs: cols,
            scrollResize: true,
            scrollY: 100,
            scrollCollapse: true,
            paging: false,
            searching: false,
            info: false,
            buttons: []
        }
    );
    table.buttons( '.export' ).remove();

</script>

{% include "includes/footer.html" %}