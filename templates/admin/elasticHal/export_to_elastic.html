{% extends "admin/base_site.html" %}
{% load i18n admin_modify %}
{% load admin_urls %}
{% load static %}
<title>{{ user.name }} ({{ user.id }})</title>

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}" />{% endblock %}
{% block bodyclass %}{{ block.super }} {{ opts.app_label }}-{{ opts.object_name.lower }} change-form{% endblock %}

{% if not is_popup %}
    {% block breadcrumbs %}
        <div class="breadcrumbs">
            <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
            &rsaquo; {% block breadcrumbs_last %}
            Export ElasticHal
            {% endblock %}
        </div>
    {% endblock %}
{% endif %}

{% block content %}
<div>

    <form action="" method="POST" enctype="multipart/form-data">
        <h1>Sélectionnez les entités à exporter vers Elastic et nécessitant une mise à jour à partir des Archives HAL:</h1>
        {{ form.as_p }}
        {% csrf_token %}
        <div class="submit-row">
            <button type="submit" class="button" >Soumettre</button>


        </div>
    </form>

</div>


<div class="container" style="padding-top: 20px;">
{% csrf_token %}
	<div class="card" style="height: 120px;">
		{% block progress %}
		<!-- JQuery -->
		<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
		<!-- Bootstrap -->
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
		<!-- Celery Progress -->
		<script src="{% static 'celery_progress/celery_progress.js' %}"></script>
    </div>

<div id="celery-result1">
    <div class="text-center" style="font-size: 14px">
        <div id="progress-bar-message1">
        Progression des index
	    </div>
    </div>
    <div class='progress-wrapper' style="padding-top: 10px;">
            <div id='progress-bar1' class='progress-bar progress-bar-striped' role='progressbar' style="height:30px; width: 0%; border-radius: 5px">&nbsp;
            </div>
    </div>
</div>
<div id="celery-result2">
    <div class='progress-wrapper' style="padding-top: 10px;">
            <div id='progress-bar2' class='progress-bar progress-bar-striped' role='progressbar' style="height:30px; width: 0%; border-radius: 5px">&nbsp;
            </div>
    </div>

    <div class="text-center" style="font-size: 14px">
          <div id="progress-bar-message2">
          Progression des docs
          </div>
    </div>
</div>


{% endblock progress %}

{% block progress_bar_js %}

{% if task_id1 or task_id2 %}

<script type="text/javascript">
	function processProgress(progressBarElement, progressBarMessageElement, progress) {
            //console.log(progress)
			progressBarElement.style.width = progress.percent + "%";
			var description = progress.description || "En attente du démarrage1...";
			progressBarMessageElement.innerHTML = description;
		}

	function processProgress1(progressBarElement, progressBarMessageElement, progress) {
            //console.log(progress)
			progressBarElement.style.width = progress.percent + "%";
			var description = progress.description || "En attente du démarrage2...";
			progressBarMessageElement.innerHTML = description;
		}

	function processResult(resultElement, result) {
		if (result.includes("finished")) {
			$( resultElement ).append(
				$('<br>')
			);
			$( resultElement ).append(
				$('<p class="text-center">').text(result)
			);
		}
	}

	// Progress Bar (JQuery)
	$(function () {
		var progressUrl1 = "{% url 'celery_progress:task_status' task_id1 %}";
        console.log(progressUrl1)
		CeleryProgressBar.initProgressBar(progressUrl1, {
			onProgress: processProgress1,
            progressBarId: "progress-bar1",
            progressBarMessageId: "progress-bar-message1",
            resultElementId: 'celery-result1'
		});

        var progressUrl2 = "{% url 'celery_progress:task_status' task_id2 %}";
        // console.log(progressUrl2)
        CeleryProgressBar.initProgressBar(progressUrl2, {
			onProgress: processProgress,
            progressBarId: "progress-bar2",
            progressBarMessageId: "progress-bar-message2",
            resultElementId: 'celery-result2'
		})
	});
</script>

{% endif %}
{% endblock progress_bar_js  %}


{% endblock %}
