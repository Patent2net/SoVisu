{% extends "admin/base_site.html" %}
{% load i18n admin_modify %}
{% load admin_urls %}
{% load static %}
<title>{{ user.name }} ({{ user.id }})</title>

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}" />{% endblock %}
{% block bodyclass %}{{ block.super }} {{ opts.app_label }}-{{ opts.object_name.lower }} change-form{% endblock %}

{% if not is_popup %}
    {% block breadcrumbs %}
        <div class="breadcrumbs">
            <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
            &rsaquo; {% block breadcrumbs_last %}
            Peuplement ElasticHal
            {% endblock %}
        </div>
    {% endblock %}
{% endif %}

{% block content %}
<div>

    <form action="" method="POST" enctype="multipart/form-data">
        <h1>S√©lectionnez les entit√©s √† remplir dans Elastic et n√©cessitant une mise √† jour √† partir des Archives HAL:</h1>
        {{ form.as_p }}
        {% csrf_token %}
        <div class="submit-row">
            <button type="submit" class="button" >Soumettre</button>


        </div>
    </form>

</div>

{% block progress %}

{% csrf_token %}
<div class="container" style="padding-top: 20px;">

<div class="hidden-progress-bar" id="pb1">
            <div class="text-center" style="font-size: 14px">
        <div id="progress-bar-message1">Progression de la v√©rification des index</div>
    </div>
            <div class='progress-wrapper' style="padding-top: 10px;">
            <div id='progress-bar1' class='progress-bar progress-bar-striped' role='progressbar' style="height:30px; width: 0%; border-radius: 5px">&nbsp;</div>
    </div>
            <div id="celery-result1"></div>
</div>
<div class="hidden-progress-bar" id="pb2">
     <div class="text-center" style="font-size: 14px">
          <div id="progress-bar-message2">Progression de l'indexation des documents laboratoires</div>
    </div>
    <div class='progress-wrapper' style="padding-top: 10px;">
            <div id='progress-bar2' class='progress-bar progress-bar-striped' role='progressbar' style="height:30px; width: 0%; border-radius: 5px">&nbsp;
            </div>
    </div>
    <div id="celery-result2"></div>
</div>
<div class="hidden-progress-bar" id="pb3">
     <div class="text-center" style="font-size: 14px">
          <div id="progress-bar-message3">Progression de l'indexation des documents chercheurs</div>
    </div>
     <div class='progress-wrapper' style="padding-top: 10px;">
            <div id='progress-bar3' class='progress-bar progress-bar-striped' role='progressbar' style="height:30px; width: 0%; border-radius: 5px">&nbsp;</div>
     </div>
     <div id="celery-result3"></div>
</div>
</div>
{% endblock progress %}

{% block progress_bar_js %}
    <style>.progress-bar {
  background-color: deepskyblue;
  height: 30px;
  width: 0px;
}</style>

		<!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
		<!-- Bootstrap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
		<!-- Celery Progress -->
    <script src="{% static 'celery_progress/celery_progress.js' %}"></script>
    <script type="text/javascript" src="{% static 'celery_progress/CustomCelery_progress.js' %}"></script>
{% if task_id1 or task_id2 or task_id3%}
<script type="text/javascript">
	function processProgress1(progressBarElement, progressBarMessageElement, progress) {
            //console.log("progress1", progress);
			progressBarElement.style.width = progress.percent + "%";
			var description = "<p>" + progress.current + " " + progress.description || "En attente du d√©marrage1..." + "</p>" ;
			progressBarMessageElement.innerHTML = description;
		}

	function processProgress2(progressBarElement, progressBarMessageElement, progress) {
            //console.log("progress2", progress);
			progressBarElement.style.width = progress.percent + "%";
			var description2 = progress.current + " " + progress.description  || "En attente du d√©marrage2...";
			//progressBarMessageElement.innerHTML = description2 ;
            progressBarMessageElement.innerText = description2 ;

		}
	function processProgress3(progressBarElement, progressBarMessageElement, progress) {
            //console.log("progress3", progress);
			progressBarElement.style.width = progress.percent + "%";
            //progressBarElement.innerHTML = Array(parseInt(progress.percent)).join("üòä");
			var description3 = progress.current + " " + progress.description  || "En attente du d√©marrage3...";
			progressBarMessageElement.innerHTML = description3 ;

		}

	function processResult(resultElement, result) {
        if (result.includes("document")) {
            $(resultElement).append($('toto'));
            console.log(result);
            }
        if (result.includes("finished")) {
                //$(resultElement).append($('<br>'));
                $(resultElement).append(
                    $('<p class="text-center">').text(result)
                );
            }

    }
</script>
{% endif %}
{% if task_id1 %}
    <script type="text/javascript">
	// Progress Bar (JQuery)
	$(function () {
		var progressUrl1 = "{% url 'celery_progress:task_status' task_id1 %}";
        //console.log(progressUrl1)
		CeleryProgressBar.initProgressBar(progressUrl1, {
			"onProgress": processProgress1,
            "progressBarId": "progress-bar1",
            "progressBarMessageId": "progress-bar-message1",
            "resultElementId": 'celery-result1'
		})
    });
    </script>
{% endif %}
{% if task_id2 %}
    <script type="text/javascript">
    $(function () {
        var progressUrl2 = "{% url 'celery_progress:task_status' task_id2 %}";
        //console.log(progressUrl2)
        CeleryProgressBar.initProgressBar(progressUrl2, {
			"onProgress": processProgress2,
            "onResult": processResult,
            "progressBarId": "progress-bar2",
            "progressBarMessageId": "progress-bar-message2",
            "resultElementId": 'celery-result2'
		})
	})
</script>
{% endif %}

{% if task_id3 %}
    <script type="text/javascript">
    $(function () {
        var progressUrl3 = "{% url 'celery_progress:task_status' task_id3 %}";
        //console.log(progressUrl2)
        CeleryProgressBar.initProgressBar(progressUrl3, {
			"onProgress": processProgress3,
            "onResult": processResult,
            "progressBarId": "progress-bar3",
            "progressBarMessageId": "progress-bar-message3",
            "resultElementId": 'celery-result3'
		})
	})
</script>


{% endif %}
{% endblock progress_bar_js  %}

{% endblock %}
</div>
