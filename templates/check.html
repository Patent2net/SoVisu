{% include "includes/header.html" with title="Vérification des données" %}
{% load widget_tweaks %}
{% load static %}
<div class="h-full w-full flex">

    {% include "includes/menu.html" with title="Vérification des données" %}
    {% comment %}
<script src="{% static 'celery_progress/celery_progress.js' %}"></script>
{% endcomment %}

    <div class="w-full h-full relative p-3" style="background: #fafbfd;">

        <div class="loading-div z-10 absolute left-0 top-0 bottom-0 right-0" style="background: #fafbfd;">
            <div class="absolute inset-center text-sm flex">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg"
                     fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Chargement des données
            </div>
        </div>

        <div class="flex flex-col bg-white rounded h-full relative"
             style="border: 1px solid rgb(211, 218, 230); padding: 6px 8px">

            <div class="flex justify-between items-start">



                <h1 class="font-semibold text-xs mb-2 border-b border-gray-300 w-full pb-1">
                    {% if entity.halStructId %}
                        <a class="px-2 pb-1
                        {% if data == "state" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=state"
                        >Membres du laboratoire</a>
                    {% endif %}
                    <a class="px-2 pb-1
                        {% if data == -1 or data == "credentials" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                       href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=credentials"
                    >Identifiants</a>
                    {% if type == "rsr" %}
                        <a class="px-2 pb-1
                        {% if data == "references" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=references&validation=1"
                        >Notices HAL</a>
                    {% endif %}
                    {% if type == "lab" %}
                        <a class="px-2 pb-1
                        {% if data == "references" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=references&validation=1"
                        >Notices HAL du labo</a>
                    {% endif %}
                    {% if type == "rsr" %}
                        <a class="px-2 pb-1
                        {% if data == "expertise" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=expertise&validation=1"
                        >Expertises identifiées</a>
                    {% endif %}
                    <a class="px-2 pb-1
                        {% if data == "guiding-domains" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                       href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=guiding-domains"
                    >Domaines d'expertise</a>
                </h1>
            </div>


            {% if data == "state" %}
                {% include "check_subtemplates/check_laboratory_state.html" %}
            {% endif %}

            {% if data == -1 or data == "credentials" %}
                {% include "check_subtemplates/check_credentials.html" %}
            {% endif %}


            {% if data == "expertise" %}
                {% include "check_subtemplates/check_expertise.html" %}
            {% endif %}

            {% if data == "references" %}

                {% include "check_subtemplates/check_references.html" %}

            {% endif %}

            {% if data == "guiding-domains" %}
                {% include "check_subtemplates/check_guiding_domains.html" %}
            {% endif %}

        </div>

    </div>

</div>

<script type="text/javascript">

    {% if data == "references" or data == "expertise" or data == "state" %}

        /* https://datatables.net/extensions/buttons/examples/initialisation/select.html#:~:text=Button's%20data%20export%20can%20interface,selected%20option%20of%20the%20exportOptions. */

        {% if validation == "1" and  type == "rsr" and data == "references" %}

            var references = JSON.parse(document.querySelector(".references-json").textContent)

            var getObjectByValue = function (array, key, value) {
                return array.filter(function (object) {
                    return object[key] === value;
                });
            };

            var table = document.getElementById("references");
            for (let i in table.rows) {
                try {
                    let row = table.rows[i]
                    let curr_rsr = getObjectByValue(references, "docid", row.cells[6].textContent);
                    if (curr_rsr[0].SearcherProfile) {
                        let curr_val = getObjectByValue(curr_rsr[0].SearcherProfile, "ldapId", '{{ id }}');
                        //console.log(curr_rsr[0].authorship)
                        //console.log(document.querySelector(".halId_s").textContent)
                        //console.log(curr_val);
                        row.cells[4].querySelector('#authorship').value = curr_val[0].authorship;
                    } else {
                        row.cells[4].querySelector('#authorship').value = "";
                    }
                } catch (error) {
                }
            }


            refUpdated = []

            const elements = document.querySelectorAll('select#authorship');
            Array.from(elements).forEach((element, index) => {

                element.onchange = (event) => {
                    let val = event.target.value;
                    let docid = element.parentNode.parentNode.querySelector(".docid").textContent;

                    refUpdated.push({'docid': docid, 'authorship': val, author: '{{ entity.ldapId|safe }}'});

                    document.querySelector("#toProcess").value = JSON.stringify(refUpdated);
                }
            });

            cols = [
                {
                    "targets": [1],
                    "className": "text-center",
                },
                {
                    "targets": [3],
                    "orderable": false
                },
                {
                    "targets": [0],
                    "render": function (data, type, row, meta) {
                        if (type === 'display') {
                            data = '<a class="underline text-blue-700" target="_blank" href="https://hal.archives-ouvertes.fr/' + data + '">' + data + '</a>';
                        }
                        return data;
                    },
                    "className": "text-center",
                    "orderable": false
                },
                {
                    "targets": [5],
                    "visible": false
                }
            ]
        {% else %}
            cols = [
                {
                    "targets": [1],
                    "className": "text-center",
                },
                {
                    "targets": [3],
                    "orderable": false
                },
                {
                    "targets": [0],
                    "render": function (data, type, row, meta) {
                        if (type === 'display') {
                            data = '<a class="underline text-blue-700" target="_blank" href="https://hal.archives-ouvertes.fr/' + data + '">' + data + '</a>';
                        }
                        return data;
                    },
                    "className": "text-center",
                    "orderable": false
                },
                {
                    "targets": [4],
                    "visible": false
                },
                {
                    "targets": [5],
                    "visible": false
                }
            ]
        {% endif %}

        $(document).ready(function () {
            var table = $('#references').DataTable(
                {
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.22/i18n/French.json'
                    },
                    dom: 'Bfrtip',
                    select: true,
                    buttons: [
                        {
                            text: 'Tout sélectionner',
                            action: function () {
                                table.rows().select();
                            }
                        },
                        {
                            text: 'Rien sélectionner',
                            action: function () {
                                table.rows().deselect();
                            }
                        }
                    ],
                    "columnDefs": cols,
                    scrollResize: true,
                    scrollY: 100,
                    scrollCollapse: true,
                    paging: false,
                }
            );

            table.on('draw', function () {
                $('.dataTables_scrollHeadInner').css('padding-right', 0);
                $('.dataTables_scrollBody').css('width', 'calc(100% - 4px)');


                $('.dataTables_filter').addClass('flex items-center');
                $('.dt-buttons').addClass('mr-2');
                $('.dataTables_filter').prepend($('.dt-buttons'));
                $('.dt-bottom-infos-rplc').prepend($('.dataTables_info'));

                $('.dataTables_info').addClass('flex justify-between w-full pr-2');
            });

            var table2 = $('#concepts').DataTable(
                {
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.22/i18n/French.json',
                    },
                    dom: 'Bfrtip',
                    select: true,
                    buttons: [
                        {
                            text: 'Tout sélectionner',
                            action: function () {
                                table.rows().select();
                            }
                        },
                        {
                            text: 'Rien sélectionner',
                            action: function () {
                                table.rows().deselect();
                            }
                        }
                    ],
                    "columnDefs": [
                        {
                            "targets": [0],
                            "visible": false
                        }
                    ],
                    scrollResize: true,
                    scrollY: 100,
                    scrollCollapse: true,
                    paging: false,
                }
            );

            table2.on('draw', function () {
                $('.dataTables_scrollHeadInner').css('padding-right', 0);
                $('.dataTables_scrollBody').css('width', 'calc(100% - 4px)');

                $('.dataTables_empty').text('Aucune expertise validée, pensez à regarder l\'onglet "Expertises retirées"');

                $('.dataTables_filter').addClass('flex items-center');
                $('.dt-buttons').addClass('mr-2');
                $('.dataTables_filter').prepend($('.dt-buttons'));
                $('.dt-bottom-infos-rplc').prepend($('.dataTables_info'));

                $('.dataTables_info').addClass('flex justify-between w-full pr-2');
            });

            var table3 = $('#state').DataTable(
                {
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.22/i18n/French.json'
                    },
                    dom: 'Bfrtip',
                    select: false,
                    buttons: [],
                    "columnDefs": [
                        {
                            "targets": [2],
                            "render": function (data, type, row, meta) {
                                if (data === 'True') {
                                    data = 'Oui';
                                } else {
                                    data = 'Non';
                                }
                                return data;
                            },
                            "className": "text-center",
                            "orderable": false
                        }
                    ],
                    scrollResize: true,
                    scrollY: 100,
                    scrollCollapse: true,
                    paging: false,
                }
            );


            table3.on('draw', function () {
                $('.dataTables_scrollHeadInner').css('padding-right', 0);
                $('.dataTables_scrollBody').css('width', 'calc(100% - 4px)');

                $('.dt-bottom-infos-rplc').prepend($('.dataTables_info'));
                $('.dataTables_filter').addClass('flex items-center');
                $('.dataTables_filter').prepend($('.dt-buttons'));

                $('.dataTables_info').addClass('flex justify-between w-full pr-2');
            });

            $('.validate').click(function () {
                toValidate = []
                table.rows('.selected').data().map(function (row) {

                    {% if validation == "1" and type == "rsr" %}
                        toValidate.push(row[6])
                    {% else %}
                        toValidate.push(row[5])
                    {% endif %}
                });

                var form = $('<form action="/validate_references/' + window.location.href.substring(window.location.href.lastIndexOf("/") + 1, window.location.href.length) + '" method="post">' +
                    '{% csrf_token %}' +
                    '<input type="text" name="toValidate" value="' + toValidate + '" />' +
                    '</form>');

                form.appendTo('body').hide()
                form.submit();
            });

            $('.expertise_field').click(function () {
                toInvalidate = []
                table2.rows('.selected').data().map(function (row) {
                    toInvalidate.push(row[0])
                });

                var form = $('<form action="/validate_expertise/' + window.location.href.substring(window.location.href.lastIndexOf("/") + 1, window.location.href.length) + '" method="post">' +
                    '{% csrf_token %}' +
                    '<input type="text" name="toInvalidate" value="' + toInvalidate + '" />' +
                    '</form>');

                form.appendTo('body').hide()
                form.submit();
            });



        });



    {% endif %}

</script>

{% include "includes/footer.html" %}
