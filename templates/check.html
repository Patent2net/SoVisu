{% include "includes/header.html" with title="Vérification des données" %}
{% load widget_tweaks %}
{% load static %}
<div class="h-full w-full flex">

    {% include "includes/menu.html" with title="Vérification des données" %}
    {% comment %}
<script src="{% static 'celery_progress/celery_progress.js' %}"></script>
{% endcomment %}

    <div class="w-full h-full relative p-3" style="background: #fafbfd;">

        <div class="loading-div z-10 absolute left-0 top-0 bottom-0 right-0" style="background: #fafbfd;">
            <div class="absolute inset-center text-sm flex">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg"
                     fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Chargement des données
            </div>
        </div>

        <div class="flex flex-col bg-white rounded h-full relative"
             style="border: 1px solid rgb(211, 218, 230); padding: 6px 8px">

            <div class="flex justify-between items-start">



                <h1 class="font-semibold text-xs mb-2 border-b border-gray-300 w-full pb-1">
                    {% if entity.halStructId %}
                        <a class="px-2 pb-1
                        {% if data == "state" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=state"
                        >Membres du laboratoire</a>
                    {% endif %}
                    <a class="px-2 pb-1
                        {% if data == -1 or data == "credentials" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                       href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=credentials"
                    >Identifiants</a>
                    {% if type == "rsr" %}
                        <a class="px-2 pb-1
                        {% if data == "references" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=references&validation=1"
                        >Notices HAL</a>
                    {% endif %}
                    {% if type == "lab" %}
                        <a class="px-2 pb-1
                        {% if data == "references" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=references&validation=1"
                        >Notices HAL du labo</a>
                    {% endif %}
                    {% if type == "rsr" %}
                        <a class="px-2 pb-1
                        {% if data == "expertise" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=expertise&validation=1"
                        >Expertises identifiées</a>
                    {% endif %}
{#                    <a class="px-2 pb-1#}
{#                        {% if data == "guiding-keywords" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"#}
{#                       href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=guiding-keywords"#}
{#                    >Mots-clés</a>#}
                    <a class="px-2 pb-1
                        {% if data == "guiding-domains" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                       href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=guiding-domains"
                    >Domaines d'expertise</a>
                    {% if type == "rsr" %}
                        <a class="px-2 pb-1
                        {% if data == "research-description" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                           href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=research-description"
                        >Descriptifs de recherche</a>
                    {% endif %}
                </h1>
            </div>


            {% if data == "state" %}

                <div class="my-3 mt-1 flex w-full bg-yellow-100 border border-yellow-300 rounded text-xs p-4 items-center text-yellow-800">
                    <svg class="w-4 h-4 text-yellow-800 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>

                    <p>Cet onglet vous permet d'affecter les chercheurs à des groupes. Cette affectation permet de produire des documents de synthèse.
                        Si le labo est la granularité que vous choisissez, laissez "Aucun axe affecté"</p>

                </div>

                <div class="justify-end flex w-full">
                    <div class="dt-buttons-rplc flex items-center text-xs">
                    </div>
                </div>

                <div class="flex-1">

                    <table id="state">

                        <thead>
                        <tr class="bg-gray-100 text-gray-700 text-xs">
                            <th class="hidden">ID</th>
                            <th>Nom</th>
                            <th>IDs validés</th>
                            <th>Axe</th>
                        </tr>
                        </thead>

                        <tbody>

                        {% for rsr in researchers %}
                            <tr class="text-gray-500">
                                <td class="hidden ldapId">{{ rsr.ldapId }}</td>
                                <td>
                                     <a class="text-blue-700 text-sm underline" target="_blank" href="/dashboard/?struct={{ struct }}&type=rsr&id={{rsr.ldapId}}">
                                     <span class=""> {{ rsr.firstName }} {{ rsr.lastName }} </span>
                                    </a>
                                </td>
                                <td>{{ rsr.validated }}</td>


                                    <td>
                                        <select class="border border-gray-300 axis" name="axis" id="axis">
                                            <option value="{{ entity.acronym }}">{{ entity.acronym }} (aucun axe défini)</option>
                                            <option value="axis1">Axe 1</option>
                                            <option value="axis2">Axe 2</option>
                                            <option value="axis3">Axe 3</option>
                                            <option value="axis4">Axe 4</option>
                                            <option value="axis5">Axe 5</option>
                                        </select>

                                    </td>
                            </tr>
                        {% endfor %}

                        </tbody>

                    </table>

                </div>

                <div class="hidden researchers-json">{{ researchers|json_script:"researchers" }}</div>

                <div class="dt-bottom-infos-rplc flex justify-between items-center">
                    <button class="update-members text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer validate outline-none whitespace-nowrap">
                        Mettre à jour
                    </button>

                </div>









            {% endif %}

            {% if data == -1 or data == "credentials" %}

                <div class="my-3 mt-1 flex w-full bg-yellow-100 border border-yellow-300 rounded text-xs p-4 items-center text-yellow-800">
                    <svg class="w-4 h-4 text-yellow-800 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>

                    <ul>
                        <li>Dans cet onglet, vous devez vérifier, renseigner ou corriger vos identifiants externes. Ces
                            id seront utilisés pour la collecte de données.
                        </li>
                        <li><strong>L'idRef</strong> s'obtient dès la publication de votre thèse. Vous devez le vérifier
                            : <a href="https://www.idref.fr/" class="underline" target="_blank">sur le site prévu à cet
                                effet</a></li>
                        <li><strong>L'OrcId</strong> est un identifiant chercheur international. <a
                                href="https://orcid.org/" class="underline" target="_blank">Nous vous recommandons d'en
                            créer un</a>. Vous avez une petite procédure réalisée par l'UMR 5206 <a
                                href="http://triangle.ens-lyon.fr/spip.php?article8796" class="underline"
                                target="_blank"> sur ce lien.</a></li>
                        <li>Enfin <strong>l'IdHal</strong> est <a
                                href="https://doc.archives-ouvertes.fr/identifiant-auteur-idhal-cv/" class="underline"
                                target="_blank">l'identifiant sur l'archive nationale Hal</a>. Ce dernier identifiant
                            permet de regrouper vos publications, produire votre cv automatiquement, mais aussi de gérer
                            les différentes formes auteur. Les trois sont à gérer via HAL. Vous avez une petite
                            procédure réalisée par l'UMR 5206 <a href="http://triangle.ens-lyon.fr/spip.php?article8796"
                                                                 class="underline" target="_blank"> sur ce lien.</a>
                        </li>
                        <li> Si vous avez <strong>d'autres identifiants</strong> (Arxiv, Mendeley, Research Gate... leurs
                            moissonneurs se chargeront de publier automatiquement vos notices sur HAL. (<i> ; </i>).
                        </li>
                        <li> Le champ autre (s'il apparait) est libre, mais la fonctionnalité n'est pas activée.</li>
                        <li><strong>merci de vérifier vos identifiants avant de les renseigner ; un mauvais identifiant
                            pouvant faire apparaitre des dysfonctionnements !</strong></li>
                    </ul>

                </div>

                <form action="/validate_credentials/?struct={{ struct }}&type={{ type }}&id={{ id }}&from={{ from }}&to={{ to }}&data={{ data }}"
                      method="post">
                    {% csrf_token %}
                    {% for field in form.visible_fields %}
                        <div>
                            {% if field.auto_id == "id_f_more" %}
                                {% render_field field class="hidden" %}
                            {% else %}
                                <label class="text-sm text-gray-700" for="{{ field.auto_id }}">{{ field.label }}</label>

                                {% render_field field class="flex text-sm py-1 px-2 border rounded border-gray-200 focus-none outline-none" %}

                            {% endif %}
                        </div>
                    {% endfor %}
                    <input class="text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer validate outline-none"
                           type="submit" value="Valider les identifiants">
                </form>



                {% if entity.aurehalId == -1 %}

                    <hr class="mb-4 mt-4"/>

                    <form action="/refresh-aurehal-id/?struct={{ struct }}&type={{ type }}&id={{ id }}&from={{ from }}&to={{ to }}&data={{ data }}"
                          method="post">
                        {% csrf_token %}
                        <p class="text-sm">
                            En cas de soucis avec la récupération de l'identifiant AuréHal, déclenchez manuellement un
                            nouvel essai en cliquant sur le bouton ci-dessous. Si l'IDhal vient d'être créé, l'AuréHalId peut être indisponible.
                            Si c'est le cas veuillez réessayer plus tard
                        </p>
                        <input class="text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer validate outline-none w-64"
                               type="submit" value="Mettre à jour l'ID AuréHAL (automatique)">
                    </form>
                {% endif %}

            {% endif %}


            {% if data == "expertise" %}

                <div class="my-3 mt-1 flex w-full bg-yellow-100 border border-yellow-300 rounded text-xs p-4 items-center text-yellow-800">
                    <svg class="w-4 h-4 text-yellow-800 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    {% if validation == "1" %}
                    <p>Cet onglet vous permet de revendiquer les domaines de votre expertise. Les raccourcis de
                        sélection Shift et CTRL fonctionnent.
                    {% endif %}
                        {% if validation == "0" %}
                        <br>Restent ici les expertises qui proviennent d'erreurs, de
                        collaborations, ou que vous considérez marginales.</p>
                        {% endif %}
                </div>

                <div class="font-semibold text-xs mb-2 border-b border-gray-300 w-full pb-1">

                    <a class="px-2 pb-1
                        {% if validation == "1" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                       href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=expertise&validation=1"
                    >Expertises validées</a>
                    <a class="px-2 pb-1
                        {% if validation == "0" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                       href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=expertise&validation=0"
                    >Expertises annexes</a>

                </div>












                <div class="justify-end flex w-full">
                    <div class="dt-buttons-rplc flex items-center text-xs">
                    </div>
                </div>

                <div class="flex-1">

                    <table id="concepts">

                        <thead>
                        <tr class="bg-gray-100 text-gray-700 text-xs">
                            <th>ID</th>
                            <th>Domaine</th>
                        </tr>
                        </thead>

                        <tbody>

                        {% for concept in concepts %}
                            <tr class="text-gray-500">
                                <td>{{ concept.id }}</td>
                                <td>{{ concept.label_fr | safe }} </td>
                            </tr>
                        {% endfor %}

                        </tbody>

                    </table>

                </div>

                <div class="dt-bottom-infos-rplc flex justify-between items-center">
                    <button class="text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer expertise_field outline-none whitespace-nowrap">
                        {% if validation == "1" %}
                            Retirer du profil
                        {% endif %}
                        {% if validation == "0" %}
                            Intégrer au profil
                        {% endif %}
                    </button>
                </div>

            {% endif %}

            {% if data == "research-description" %}

                <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

                <div class="my-3 mt-1 flex w-full bg-yellow-100 border border-yellow-300 rounded text-xs p-4 items-center text-yellow-800">
                    <svg class="w-4 h-4 text-yellow-800 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p>Dans cet onglet, vous devez renseigner les mots-clés génériques de votre expertise, séparés par des ";". Vous pouvez aussi proposer un descriptif plus ou moins long présentant vos
                        recherches (actuellement non utilisé). Vous pouvez utiliser la barre d'outil pour mettre en forme votre texte, ajouter des
                        images, etc.</p>
                </div>

                <!-- Include the Quill library -->
                <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

                <h4 class="text-xs font-semibold pb-2">Mots-clés :</h4>
                <div id="guidingKeywords">
                    {{ guidingKeywords | safe }}
                </div>

                <h4 class="text-xs font-semibold pb-2 mt-4">Résumé des travaux :</h4>
                <div id="research_summary">
                    {{ research_summary | safe }}
                </div>

                <h4 class="text-xs font-semibold pb-2 mt-4">Projets (porteurs) en cours :</h4>
                <div id="research_projectsInProgress">
                    {{ research_projectsInProgress | safe }}
                </div>

                <h4 class="text-xs font-semibold pb-2 mt-4">Projets et financements :</h4>
                <div id="research_projectsAndFundings">
                    {{ research_projectsAndFundings | safe }}
                </div>


                <form action="/validate_research-description/?struct={{ struct }}&type={{ type }}&id={{ id }}&from={{ from }}&to={{ to }}&data={{ data }}"
                      method="post">
                    {% csrf_token %}
                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}
                    {% for field in form.visible_fields %}
                        <div>
                            {% render_field field class="hidden flex text-sm py-1 px-2 border rounded border-gray-200 focus-none outline-none" %}
                        </div>
                    {% endfor %}
                    <input class="text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer validate outline-none"
                           type="submit" value="Valider">
                </form>

                <script>
                    options = [
                        ['bold', 'italic'],
                        ['link', 'image'],
                        [{'header': [1, 2, 3, 4, 5, 6, false]}],
                        [{'align': ['', 'center', 'right', 'justify']}],
                        [{list: 'ordered'}, {list: 'bullet'}]
                    ];

                    var quill4 = new Quill('#guidingKeywords', {
                        modules: {
                            toolbar: options
                        },
                        theme: 'snow'
                    });

                    var quill1 = new Quill('#research_summary', {
                        modules: {
                            toolbar: options
                        },
                        theme: 'snow'
                    });

                    var quill2 = new Quill('#research_projectsInProgress', {
                        modules: {
                            toolbar: options
                        },
                        theme: 'snow'
                    });


                    var quill3 = new Quill('#research_projectsAndFundings', {
                        modules: {
                            toolbar: options
                        },
                        theme: 'snow'
                    });

                    // tttttttttttttttttttttttttttttttttttttttttttttttttttttt



                    var myElement0 = document.getElementById('guidingKeywords');
                    if (window.addEventListener) {
                        // Normal browsers
                        myElement0.addEventListener('DOMSubtreeModified', contentChanged0, false);
                    } else if (window.attachEvent) {
                        // IE
                        myElement0.attachEvent('DOMSubtreeModified', contentChanged0);
                    }

                    function contentChanged0() {
                        document.getElementById('id_f_guidingKeywords').value = myElement0.innerText;
                    }

                    // tttttttttttttttttttttttttttttttttttttttttttttttttttttt



                    var myElement1 = document.getElementById('research_summary');
                    if (window.addEventListener) {
                        // Normal browsers
                        myElement1.addEventListener('DOMSubtreeModified', contentChanged1, false);
                    } else if (window.attachEvent) {
                        // IE
                        myElement1.attachEvent('DOMSubtreeModified', contentChanged1);
                    }

                    function contentChanged1() {
                        document.getElementById('id_f_research_summary').value = myElement1.innerHTML;
                    }

                    // ttttttttttttttttttttttttttttttttttttttttttttttttttttttt

                    var myElement2 = document.getElementById('research_projectsInProgress');
                    if (window.addEventListener) {
                        // Normal browsers
                        myElement2.addEventListener('DOMSubtreeModified', contentChanged2, false);
                    } else if (window.attachEvent) {
                        // IE
                        myElement2.attachEvent('DOMSubtreeModified', contentChanged2);
                    }

                    function contentChanged2() {
                        document.getElementById('id_f_research_projectsInProgress').value = myElement2.innerHTML;
                    }

                    // ttttttttttttttttttttttttttttttttttttttttttttttttttttttt

                    var myElement3 = document.getElementById('research_projectsAndFundings');
                    if (window.addEventListener) {
                        // Normal browsers
                        myElement3.addEventListener('DOMSubtreeModified', contentChanged3, false);
                    } else if (window.attachEvent) {
                        // IE
                        myElement3.attachEvent('DOMSubtreeModified', contentChanged3);
                    }

                    function contentChanged3() {
                        document.getElementById('id_f_research_projectsAndFundings').value = myElement3.innerHTML;
                    }


                </script>

            {% endif %}


            {% if data == "references" %}

                <div class="my-3 mt-1 flex w-full bg-yellow-100 border border-yellow-300 rounded text-xs p-4 items-center text-yellow-800">
                    <svg class="w-4 h-4 text-yellow-800 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    {% if validation == "1" %}
                    <p>Dans cet onglet, vous intégrez les références bibliographiques collectées à l'aide de vos
                        identifiants aux index. Vous pouvez exclure des notices et ne pas les associer à votre profil. Cette opération est réversible. Les
                        raccourcis de sélection <i>Shift</i> et <i>CTRL</i> fonctionnent.

                        <br>S'il manquait des références, à vous de les ajouter sur Hal à l'aide de vos identifiants. Le
                        bouton "Mettre à jour les références" sert à les importer ici (Notez qu'Hal prend un délai
                        d'indexation de quelques heures et les nouvelles notices ne sont pas immédiatement
                        disponibles.). </p>
                    {% endif %}
                    {% if validation == "0" %} <p>

                    <br>Restent ici les publications "annexes", pas forcément au c\oe ur de votre expertise ou qui ne seraient pas de vous par erreur...
                    </p>
                    {% endif %}
                </div>

                <div class="flex justify-between items-start">

                    <div class="font-semibold text-xs mb-2 border-b border-gray-300 w-full pb-1">
                        {% if type == "rsr" %}
                            <a class="px-2 pb-1
                        {% if validation == "1" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                               href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=references&validation=1"
                            >Notices validées</a>
                            <a class="px-2 pb-1
                        {% if validation == "0" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                               href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=references&validation=0"
                            >Notices retirées</a>
                        {% endif %}

                        {% if type == "lab" %}
                            <a class="px-2 pb-1
                        {% if validation == "1" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                               href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=references&validation=1"
                            >Notices validées</a>
                            <a class="px-2 pb-1
                        {% if validation == "0" %}text-blue-600 border-b-2 border-blue-400 {% else %} text-gray-600 {% endif %}"
                               href="/check/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&data=references&validation=0"
                            >Notices annexes</a>
                        {% endif %}
                    </div>

                    <div class="dt-buttons-rplc flex mb-2 items-center text-xs flex-col relative">
                        {% if type == "rsr" %}
                            <div class="flex">
                            <a class="px-2 pb-1 font-semibold text-xs whitespace-nowrap text-blue-700
                        text-gray-600 flex mr-2 border-b-2 border-blue-300"
                               href="/force-update_references/?struct={{ struct }}{% if type %}&type={{ type }}{% endif %}{% if id %}&id={{ id }}{% endif %}{% if from %}&from={{ from }}{% endif %}{% if to %}&to={{ to }}{% endif %}&filter=all&validation={{ validation }}"
                            > Collecter HAL
                            </a>
                            <div class="flex">
                                    <div class='progress-wrapper bg-gray-200 w-48 rounded relative' style="height: 20px">

                                        <div id='progress-bar' class='bg-blue-200 progress-bar progress-bar-striped rounded' role='progressbar' style="height: 20px">
                                        </div>
                                        <div id="progress-bar-message" class="mr-1 ml-1 absolute top-0 py-0.5 px-1">Progression de collecte</div>
                                    </div>
                                    <div id="celery-result" class=""></div>
                                </div>
                            </div>
{#                                Collecter (ou mettre à jour) de nouvelles références</a>#}

                        {% endif %}

                    </div>
                </div>

                <div class="flex-1">

                    <table id="references">

                        <thead>
                        <tr class="bg-gray-100 text-gray-700 text-xs">
                            <th>URL</th>
                            <th>Année</th>
                            <th>Type</th>
                            <th>Titre</th>
                            {% if validation == "1" and type == "rsr" %}
                                <th>Autorat</th>
                            {% endif %}
                            <th>label_bibtex</th>
                            <th class="hidden">docid</th>
                        </tr>
                        </thead>

                        <tbody>

                        {% for ref in references %}
                            <tr class="text-gray-500">
                                <td class="whitespace-nowrap">{{ ref.halId_s }}</td>
                                <td>{{ ref.publicationDate_tdate|slice:":4" }}</td>
                                <td>{{ ref.docType_s }}</td>
                                <td>{{ ref.title_s.0 | safe }}</td>
                                {% if validation == "1" and type == "rsr" %}
                                    <td>
                                        <select class="border border-gray-300 author" name="authorship" id="authorship">
                                            <option value="">---</option>
                                            <option value="firstAuthor">Premier auteur</option>
                                            <option value="lastAuthor">Dernier auteur</option>
                                            <option value="correspondingAuthor">Corresponding auteur</option>
                                        </select>
                                    </td>
                                {% endif %}
                                <td>{{ ref.label_bibtex }}</td>
                                <td class="docid hidden">{{ ref.docid }}</td>
                            </tr>
                        {% endfor %}

                        </tbody>

                    </table>

                </div>

                {% if validation == "1" and type == "rsr" %}
                            {% comment %} POURQUOI RIEN DANS CE CAS ???? {% endcomment %}


                {% endif %}

                <div class="hidden references-json">{{ references|json_script:"references" }}</div>
                <div class="hidden halId_s">{{ entity.halId_s|safe }}</div>

                <div class="dt-bottom-infos-rplc flex justify-between items-center">
                    {% if validation == "1" %}

                    <form action="/update_authorship/?struct={{ struct }}&type={{ type }}&id={{ id }}&data={{ data }}&from={{ from }}&to={{ to }}" method="post" class="mr-2">
                            {% csrf_token %}
                            <input id="toProcess" name="toProcess" class="hidden"/>
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            {% for field in form.visible_fields %}
                                <div>
                                    <label class="text-sm text-gray-700" for="{{ field.auto_id }}">{{ field.label }}</label>
                                    {% render_field field class="flex text-sm py-1 px-2 border rounded border-gray-200 focus-none outline-none" %}
                                </div>
                            {% endfor %}

                            {% if  type == "rsr" %}
                                <input class="text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer validate outline-none whitespace-nowrap" type="submit" value="Mettre à jour l'autorat">
                            {% endif %}

                        </form>

                    {% endif %}
                    <button class="text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer validate outline-none whitespace-nowrap">
                        {% if validation == "1" %}
                            Retirer du profil
                        {% endif %}
                        {% if validation == "0" %}
                            Intégrer au profil
                        {% endif %}
                    </button>
                </div>

            {% endif %}

            {% if data == "guiding-domains" %}

                <div class="my-3 mt-1 flex w-full bg-yellow-100 border border-yellow-300 rounded text-xs p-4 items-center text-yellow-800">
                    <svg class="w-4 h-4 text-yellow-800 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p>Dans cet onglet, vous pouvez sélectionner un ou plusieurs domaine(s) qui décrivent ou complètent
                        votre expertise. Cette terminologie servira à diriger et contrôler les expansions sémantiques de
                        vos données récoltées pour indexation.</p>
                </div>

                <div class="w-full" id="tree" style="overflow-y: scroll;"></div>

                <div class="selected-doms flex justify-between absolute bottom-0 right-0 pl-2 pr-2">
                    <div class="dt-bottom-infos-rplc flex justify-between items-center">
                        <button class="text-xs font-semibold py-1 px-2 rounded bg-blue-600 my-2 text-white cursor-pointer validate-doms outline-none">
                            Valider
                        </button>
                    </div>
                </div>

            {% endif %}

        </div>

    </div>

</div>

<script type="text/javascript">

    {% if data == "guiding-domains" %}

        var selectedDoms = {% autoescape off %}{{ guidingDomains }}{% endautoescape %};
        var entityDomains = {% autoescape off %}{{ guidingDomains }}{% endautoescape %};
        entityDomains = entityDomains.filter(item => item);

        var entityDomainsFull = [];


        for (var i = 0; i < entityDomains.length; i++) {
            entityDomainsTmp = entityDomains[i].split('.')

            entityDomainsFull.push('to-' + entityDomainsTmp[0])
            entityDomainsFull.push('to-' + entityDomains[i].replaceAll('.', '_'))
        }

        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }

        var entityDomainsFull = entityDomainsFull.filter(onlyUnique);

        function refreshHlPath() {
            for (var i = 0; i < entityDomainsFull.length; i++) {
                $('path.' + entityDomainsFull[i]).attr("stroke", "green");
            }
        }




        function graph(rootData = root) {

            // using the cell value for data, instead of passing as a variable
            // to try out the "include with" style of templating
            const root = rootData;

            root.x0 = dy / 2;
            root.y0 = 0;
            root.descendants().forEach((d, i) => {
                d.id = i;
                d._children = d.children;
                if (d.depth >= initDepth) d.children = null;
                //if (d.depth && d.data.name.length !== 3) d.children = null;
            });

            const svg = d3
                .select("#tree")
                .append("svg")
                .attr("viewbox", [-margin.left, -margin.top, width, dx])
                .style("font", "11px sans-serif")
                .style("user-select", "none");

            const gLink = svg
                .append("g")
                .attr("fill", "none")
                .attr("stroke", "#BFDBFE")
                .attr("stroke-opacity", 0.4)
                .attr("stroke-width", 1.5);

            const gNode = svg
                .append("g")
                .attr("cursor", "pointer")
                .attr("pointer-events", "all");

            function update(source) {
                const duration = d3.event && d3.event.altKey ? 2500 : 250;
                const nodes = root.descendants().reverse();
                const links = root.links();

                // calc the new tree layout
                tree(root);

                let left = root;
                let right = root;
                root.eachBefore(node => {
                    if (node.x < left.x) left = node;
                    if (node.x > right.x) right = node;
                });

                const height = right.x - left.x + margin.top + margin.bottom;
                // const height = $('#tree').height();

                // transition the size of the viewbox
                const transition = svg
                    .transition()
                    .duration(duration)
                    .attr("viewBox", [-margin.left, left.x - margin.top, width, height])
                    .tween(
                        "resize",
                        window.ResizeObserver ? null : () => () => svg.dispatch("toggle")
                    );

                // Update the nodes…
                const node = gNode.selectAll("g").data(nodes, d => d.id);

                // Enter any new nodes at the parent's previous position.
                const nodeEnter = node
                    .enter()
                    .append("g")
                    .attr("transform", d => `translate(${source.y0},${source.x0})`)
                    .attr("fill-opacity", 0)
                    .attr("stroke-opacity", 0)
                    .on("click", d => {

                        if (d.data.children.length == 0) {
                            if ($('text.' + d.data.id.replaceAll('.', '-')).hasClass('dom-selected')) {
                                for (var i = 0; i < selectedDoms.length; i++) {
                                    if (selectedDoms[i] === d.data.id) {
                                        selectedDoms.splice(i, 1);
                                    }
                                }
                                $('text.' + d.data.id.replaceAll('.', '-')).removeClass('dom-selected')
                            } else {
                                selectedDoms.push(d.data.id);
                                $('text.' + d.data.id.replaceAll('.', '-')).addClass('dom-selected')
                            }

                        }

                        d.children = d.children ? null : d._children;
                        update(d);
                    });

                nodeEnter
                    .append("circle")
                    .attr("r", 2.5)
                    .attr("fill", d => (d._children ? "#555" : "#bbb"))
                    .attr("stroke-width", 10);

                nodeEnter
                    .append("text")
                    .attr('class', d => {
                        if (entityDomains.includes(d.data.id)) {
                            return 'dom-selected ' + d.data.id.replaceAll('.', '-');
                        }
                        return d.data.id.replaceAll('.', '-');
                    })
                    .attr("dy", "0.31em")
                    .attr("x", d => (d._children ? -6 : 6))
                    .attr("text-anchor", d => (d._children ? "end" : "start"))
                    .text(d => d.data.label_fr)
                    .attr("fill", "#374151")
                    .clone(true)
                    .lower()
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-width", 3)
                    .attr("stroke", "white");

                // Transition nodes to their new position.
                const nodeUpdate = node
                    .merge(nodeEnter)
                    .transition(transition)
                    .attr("transform", d => `translate(${d.y},${d.x})`)
                    .attr("fill-opacity", 1)
                    .attr("font-style", d => (d._children ? "normal" : "italic"))
                    .attr("stroke-opacity", 1);

                // Transition exiting nodes to the parent's new position.
                const nodeExit = node
                    .exit()
                    .transition(transition)
                    .remove()
                    .attr("transform", d => `translate(${source.y},${source.x})`)
                    .attr("fill-opacity", 0)
                    .attr("stroke-opacity", 0);

                // Update the links…
                const link = gLink.selectAll("path").data(links, d => d.target.id);

                // Enter any new links at the parent's previous position.
                const linkEnter = link
                    .enter()
                    .append("path")
                    .attr("class", d => {
                        return ('to-' + d.target.data.id.split('.').join('_'))
                    })
                    .attr("d", d => {
                        const o = {x: source.x0, y: source.y0};
                        return diagonal({source: o, target: o});
                    });

                // Transition links to their new position.
                link
                    .merge(linkEnter)
                    .transition(transition)
                    .attr("d", diagonal);

                // Transition exiting nodes to the parent's new position.
                link
                    .exit()
                    .transition(transition)
                    .remove()
                    .attr("d", d => {
                        const o = {x: source.x, y: source.y};
                        return diagonal({source: o, target: o});
                    });

                // Stash the old positions for transition.
                root.eachBefore(d => {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }

            update(root);
            $('#tree').height($('#tree-up-details').height() + 12)
            return svg.node();
        }

        width = $('#tree').width();

        data = {% autoescape off %}{{ domains }}{% endautoescape %};
        data["label"] = "Concepts"

        if (data.length == 1) {
            data = data[0]
            data["label"] = "Concepts"
        }

        root = d3.hierarchy(data);
        dx = 20
        dy = width / 4
        tree = d3.tree().nodeSize([dx, dy])
        diagonal = d3
            .linkHorizontal()
            .x(d => d.y)
            .y(d => d.x)
        margin = ({top: 12, right: 12, bottom: 12, left: 3})
        initDepth = 1
        graph()

        $('.validate-doms').click(function () {

            var form = $('<form action="/validate_guiding-domains/' + window.location.href.substring(window.location.href.lastIndexOf("/") + 1, window.location.href.length) + '" method="post">' +
                '{% csrf_token %}' +
                '<input type="text" name="toValidate" value="' + selectedDoms + '" />' +
                '</form>');

            form.appendTo('body').hide()
            form.submit();
        });

    {% endif %}

    {% if data == "references" or data == "expertise" or data == "state" %}

        /* https://datatables.net/extensions/buttons/examples/initialisation/select.html#:~:text=Button's%20data%20export%20can%20interface,selected%20option%20of%20the%20exportOptions. */

        {% if validation == "1" and  type == "rsr" and data == "references" %}
            {%  if taches %}
                var progressUrl = "{% url 'celery_progress:task_status' taches %}";

                $(function () {
      CeleryProgressBar.initProgressBar(progressUrl, {
        onResult: customResult,
        onProgress: customProgress,
        onSuccess: customSuccess,
      })
    });
            {%  endif %}

            var references = JSON.parse(document.querySelector(".references-json").textContent)

            var getObjectByValue = function (array, key, value) {
                return array.filter(function (object) {
                    return object[key] === value;
                });
            };

            var table = document.getElementById("references");
            for (let i in table.rows) {
                try {
                    let row = table.rows[i]
                    let curr_rsr = getObjectByValue(references, "docid", row.cells[6].textContent);
                    if (curr_rsr[0].authorship) {
                        let curr_val = getObjectByValue(curr_rsr[0].authorship, "authIdHal_s", document.querySelector(".halId_s").textContent);
                        //console.log(curr_rsr[0].authorship)
                        //console.log(document.querySelector(".halId_s").textContent)
                        //console.log(curr_val);
                        row.cells[4].querySelector('#authorship').value = curr_val[0].authorship;
                    } else {
                        row.cells[4].querySelector('#authorship').value = "";
                    }
                } catch (error) {
                }
            }


            refUpdated = []

            const elements = document.querySelectorAll('select#authorship');
            Array.from(elements).forEach((element, index) => {

                element.onchange = (event) => {
                    let val = event.target.value;
                    let docid = element.parentNode.parentNode.querySelector(".docid").textContent;

                    refUpdated.push({'docid': docid, 'authorship': val, author: '{{ entity.ldapId|safe }}'});

                    document.querySelector("#toProcess").value = JSON.stringify(refUpdated);
                }
            });

            cols = [
                {
                    "targets": [1],
                    "className": "text-center",
                },
                {
                    "targets": [3],
                    "orderable": false
                },
                {
                    "targets": [0],
                    "render": function (data, type, row, meta) {
                        if (type === 'display') {
                            data = '<a class="underline text-blue-700" target="_blank" href="https://hal.archives-ouvertes.fr/' + data + '">' + data + '</a>';
                        }
                        return data;
                    },
                    "className": "text-center",
                    "orderable": false
                },
                {
                    "targets": [5],
                    "visible": false
                }
            ]
        {% else %}
            cols = [
                {
                    "targets": [1],
                    "className": "text-center",
                },
                {
                    "targets": [3],
                    "orderable": false
                },
                {
                    "targets": [0],
                    "render": function (data, type, row, meta) {
                        if (type === 'display') {
                            data = '<a class="underline text-blue-700" target="_blank" href="https://hal.archives-ouvertes.fr/' + data + '">' + data + '</a>';
                        }
                        return data;
                    },
                    "className": "text-center",
                    "orderable": false
                },
                {
                    "targets": [4],
                    "visible": false
                },
                {
                    "targets": [5],
                    "visible": false
                }
            ]
        {% endif %}

        $(document).ready(function () {
            var table = $('#references').DataTable(
                {
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.22/i18n/French.json'
                    },
                    dom: 'Bfrtip',
                    select: true,
                    buttons: [
                        {
                            text: 'Tout sélectionner',
                            action: function () {
                                table.rows().select();
                            }
                        },
                        {
                            text: 'Rien sélectionner',
                            action: function () {
                                table.rows().deselect();
                            }
                        }
                    ],
                    "columnDefs": cols,
                    scrollResize: true,
                    scrollY: 100,
                    scrollCollapse: true,
                    paging: false,
                }
            );

            table.on('draw', function () {
                $('.dataTables_scrollHeadInner').css('padding-right', 0);
                $('.dataTables_scrollBody').css('width', 'calc(100% - 4px)');


                $('.dataTables_filter').addClass('flex items-center');
                $('.dt-buttons').addClass('mr-2');
                $('.dataTables_filter').prepend($('.dt-buttons'));
                $('.dt-bottom-infos-rplc').prepend($('.dataTables_info'));

                $('.dataTables_info').addClass('flex justify-between w-full pr-2');
            });

            var table2 = $('#concepts').DataTable(
                {
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.22/i18n/French.json',
                    },
                    dom: 'Bfrtip',
                    select: true,
                    buttons: [
                        {
                            text: 'Tout sélectionner',
                            action: function () {
                                table.rows().select();
                            }
                        },
                        {
                            text: 'Rien sélectionner',
                            action: function () {
                                table.rows().deselect();
                            }
                        }
                    ],
                    "columnDefs": [
                        {
                            "targets": [0],
                            "visible": false
                        }
                    ],
                    scrollResize: true,
                    scrollY: 100,
                    scrollCollapse: true,
                    paging: false,
                }
            );

            table2.on('draw', function () {
                $('.dataTables_scrollHeadInner').css('padding-right', 0);
                $('.dataTables_scrollBody').css('width', 'calc(100% - 4px)');

                $('.dataTables_empty').text('Aucune expertise validée, pensez à regarder l\'onglet "Expertises retirées"');

                $('.dataTables_filter').addClass('flex items-center');
                $('.dt-buttons').addClass('mr-2');
                $('.dataTables_filter').prepend($('.dt-buttons'));
                $('.dt-bottom-infos-rplc').prepend($('.dataTables_info'));

                $('.dataTables_info').addClass('flex justify-between w-full pr-2');
            });

            var table3 = $('#state').DataTable(
                {
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.22/i18n/French.json'
                    },
                    dom: 'Bfrtip',
                    select: false,
                    buttons: [],
                    "columnDefs": [
                        {
                            "targets": [2],
                            "render": function (data, type, row, meta) {
                                if (data === 'True') {
                                    data = 'Oui';
                                } else {
                                    data = 'Non';
                                }
                                return data;
                            },
                            "className": "text-center",
                            "orderable": false
                        }
                    ],
                    scrollResize: true,
                    scrollY: 100,
                    scrollCollapse: true,
                    paging: false,
                }
            );


            table3.on('draw', function () {
                $('.dataTables_scrollHeadInner').css('padding-right', 0);
                $('.dataTables_scrollBody').css('width', 'calc(100% - 4px)');

                $('.dt-bottom-infos-rplc').prepend($('.dataTables_info'));
                $('.dataTables_filter').addClass('flex items-center');
                $('.dataTables_filter').prepend($('.dt-buttons'));

                $('.dataTables_info').addClass('flex justify-between w-full pr-2');
            });

            {% if data == "state" %}

                var researchers = JSON.parse(document.querySelector('.researchers-json').textContent)

                var getObjectByValue = function (array, key, value) {
                    return array.filter(function (object) {
                        return object[key] === value;
                    });
                };

                var table = document.getElementById("state");
                for (let i in table.rows) {
                    try {
                        let row = table.rows[i]
                        let curr_rsr = getObjectByValue(researchers, "ldapId", row.cells[0].textContent);
                        if (curr_rsr[0].axis) {
                            row.cells[3].querySelector('#axis').value = curr_rsr[0].axis;
                        } else {
                            row.cells[3].querySelector('#axis').value = "{{ entity.acronym }}";
                        }
                    } catch (error) {
                    }
                }

                membersUpdated = []

                const elements = document.querySelectorAll('select.axis');
                Array.from(elements).forEach((element, index) => {

                    element.onchange = (event) => {
                        let val = event.target.value;
                        let ldapId = parentNode = element.parentNode.parentNode.querySelector(".ldapId").textContent;

                        membersUpdated.push(ldapId + ":" + val);
                    }
                });

                $('.update-members').click(function () {

                    var form = $('<form action="/update_members/' + window.location.href.substring(window.location.href.lastIndexOf("/") + 1, window.location.href.length) + '" method="post">' +
                        '{% csrf_token %}' +
                        '<input type="text" name="toUpdate" value="' + membersUpdated + '" />' +
                        '</form>');

                    form.appendTo('body').hide()
                    form.submit();
                });

            {% endif %}


            $('.validate').click(function () {
                toValidate = []
                table.rows('.selected').data().map(function (row) {

                    {% if validation == "1" and type == "rsr" %}
                        toValidate.push(row[6])
                    {% else %}
                        toValidate.push(row[5])
                    {% endif %}
                });

                var form = $('<form action="/validate_references/' + window.location.href.substring(window.location.href.lastIndexOf("/") + 1, window.location.href.length) + '" method="post">' +
                    '{% csrf_token %}' +
                    '<input type="text" name="toValidate" value="' + toValidate + '" />' +
                    '</form>');

                form.appendTo('body').hide()
                form.submit();
            });

            $('.expertise_field').click(function () {
                toInvalidate = []
                table2.rows('.selected').data().map(function (row) {
                    toInvalidate.push(row[0])
                });

                var form = $('<form action="/validate_expertise/' + window.location.href.substring(window.location.href.lastIndexOf("/") + 1, window.location.href.length) + '" method="post">' +
                    '{% csrf_token %}' +
                    '<input type="text" name="toInvalidate" value="' + toInvalidate + '" />' +
                    '</form>');

                form.appendTo('body').hide()
                form.submit();
            });



        });



    {% endif %}


</script>

{% include "includes/footer.html" %}
